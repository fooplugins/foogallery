# PRD-003: Harden Gallery Page Creation and Cache Clear AJAX

## Issue Summary
Gallery-related AJAX endpoints verify nonces but skip capability checks. Some endpoints create content or clear caches without verifying that the current user can edit the target gallery or manage settings.

## Affected Endpoints
- `foogallery_create_gallery_page` in `includes/admin/class-gallery-metaboxes.php`
- `foogallery_clear_gallery_thumb_cache` in `includes/admin/class-gallery-metaboxes.php`
- `foogallery_clear_attachment_thumb_cache` in `includes/admin/class-gallery-metaboxes.php`

## Risk/Impact
- Unauthorized users could create draft pages or clear caches for galleries/attachments.
- Cross-site effects possible in multisite.

## Recommended Fix
1. Add capability checks after nonce verification:
   - `current_user_can( 'edit_post' )` for gallery page creation (to check if the user can create posts)
   - `current_user_can( 'edit_post', $foogallery_id )` for gallery cache clearing.
   - `current_user_can( 'edit_post', $attachment_id )` for attachment cache clearing.
2. Validate IDs with `absint`.
3. If authorization fails, return `wp_send_json_error` with 403 status.

## Files/Functions
- `includes/admin/class-gallery-metaboxes.php`
  - `ajax_create_gallery_page()`
  - `ajax_clear_gallery_thumb_cache()`
  - `ajax_clear_attachment_thumb_cache()`

## Implementation Notes
- Validate that the gallery/attachment exists before acting.
- Prefer `wp_send_json_success`/`wp_send_json_error` responses for consistency.

## Acceptance Criteria
- Unauthorized users cannot create pages or clear caches.
- Authorized users can complete the actions.
- If responses switch to `wp_send_json_success`/`wp_send_json_error`, confirm the initiating JavaScript handler still parses the response correctly.

## Test Plan
- Add `WP_Ajax_UnitTestCase` tests for each action: `foogallery_create_gallery_page`, `foogallery_clear_gallery_thumb_cache`, `foogallery_clear_attachment_thumb_cache`.
- Assert subscribers receive 403 with valid nonce.
- Assert editors/admins can perform the action and return success.

## Final Cleanup
- After tests pass and the fix is complete, ask the user whether to delete this PRD and include the deletion in the final commit.
