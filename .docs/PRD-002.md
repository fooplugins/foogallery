# PRD-002: Restrict Gallery Preview AJAX

## Issue Summary
The gallery preview AJAX endpoint uses a nonce check but does not enforce `edit_post` or gallery ownership checks, which can expose gallery data across sites in multisite or to unauthorized roles if a nonce is leaked.

## Affected Endpoint
- `foogallery_preview` in `includes/admin/class-gallery-metabox-items.php`

## Risk/Impact
- Unauthorized preview of galleries and attachments.
- Possible cross-site information disclosure in multisite.

## Recommended Fix
1. After nonce verification, enforce:
   - `current_user_can( 'edit_post', $foogallery_id )`.
2. Validate inputs:
   - Use `absint` for `foogallery_id`.
   - Sanitize `foogallery_template` with `sanitize_key` (already present).
3. Return errors via `wp_send_json_error` and `wp_send_json_success` rather than `echo`/`die` to standardize responses.

## Files/Functions
- `includes/admin/class-gallery-metabox-items.php`
  - `ajax_gallery_preview()`

## Implementation Notes
- Guard early if the gallery ID is invalid or the gallery does not exist.
- Ensure the preview rendering only happens for authorized users.

## Acceptance Criteria
- Unauthorized users receive a 403 JSON error.
- Authorized users can still preview galleries.
- If responses switch to `wp_send_json_success`/`wp_send_json_error`, confirm the initiating JavaScript handler still parses the response correctly.

## Test Plan
- Add `WP_Ajax_UnitTestCase` coverage for `foogallery_preview`.
- Use `wp_set_current_user` with subscriber vs editor and assert JSON error vs success.
- Include an invalid `foogallery_id` request returning 400/404.

## Final Cleanup
- After tests pass and the fix is complete, ask the user whether to delete this PRD and include the deletion in the final commit.
