# PRD-005: Require Capabilities for Settings AJAX Actions

## Issue Summary
Settings-related AJAX handlers use nonce checks but lack capability verification. This can allow authenticated users who obtain a nonce to clear caches or run operations that should be restricted to admins.

## Affected Endpoints
- `foogallery_clear_css_optimizations` in `includes/admin/class-settings.php`
- `foogallery_thumb_generation_test` in `includes/admin/class-settings.php`
- `foogallery_apply_retina_defaults` in `includes/admin/class-settings.php`

## Risk/Impact
- Unauthorized users could clear caches or modify gallery defaults.
- Potential data integrity issues and cross-site effects in multisite.

## Recommended Fix
1. After nonce verification, require `current_user_can( 'manage_options' )`.
2. Sanitize input values (e.g., `$_POST['defaults']`) with `wp_unslash` and `sanitize_text_field` or a more structured parser as needed.
3. Return JSON success/error responses instead of raw `echo`/`die`.

## Files/Functions
- `includes/admin/class-settings.php`
  - `ajax_clear_css_optimizations()`
  - `ajax_thumb_generation_test()`
  - `ajax_apply_retina_defaults()`

## Implementation Notes
- Use `check_ajax_referer( 'action', 'nonce', false )` to allow JSON errors.
- Consider requiring `current_user_can( 'edit_posts' )` or `manage_options` depending on the settings impact; `manage_options` is safer.

## Acceptance Criteria
- Only administrators can run these AJAX actions.
- Unauthorized users receive a 403 JSON error.

## Test Plan
- Add `WP_Ajax_UnitTestCase` tests for `foogallery_clear_css_optimizations`, `foogallery_thumb_generation_test`, and `foogallery_apply_retina_defaults`.
- Use subscriber vs admin users and assert 403 vs success.
