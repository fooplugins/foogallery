# PRD-001: Lock Down Attachment Modal AJAX Endpoints

## Issue Summary
Several attachment modal AJAX handlers verify nonces but do not check user capabilities or ownership. This can allow authenticated users (especially on multisite networks) to open or mutate attachment data they should not access if they can obtain/guess a nonce.

## Affected Endpoints
- `foogallery_attachment_modal_open` in `includes/admin/class-gallery-attachment-modal.php`
- `foogallery_attachment_modal_save` in `includes/admin/class-gallery-attachment-modal.php`
- `foogallery_attachment_modal_taxonomy_add` in `includes/admin/class-gallery-attachment-modal.php`

## Risk/Impact
- Potential unauthorized viewing of attachment metadata.
- Potential unauthorized modification of attachment metadata or taxonomy creation.
- Cross-site information disclosure in multisite if nonces are shared/accessible.

## Recommended Fix
1. After nonce verification, enforce capability checks:
   - Require `current_user_can( 'edit_post', $img_id )` for open/save operations.
   - Require `current_user_can( 'assign_terms', $taxonomy )` or taxonomy cap checks for taxonomy creation.
   - For open modal, also validate gallery ownership if `gallery_id` is provided.
2. Validate inputs robustly:
   - Use `absint` for IDs (`img_id`, `gallery_id`).
   - Sanitize taxonomy and term fields with `sanitize_key`/`sanitize_text_field`.
3. Return JSON errors using `wp_send_json_error` with clear messages instead of `die( 'Busted!' )`.

## Files/Functions
- `includes/admin/class-gallery-attachment-modal.php`
  - `ajax_open_modal()`
  - `ajax_save_modal()`
  - `ajax_add_taxonomy()`

## Implementation Notes
- Use `check_ajax_referer( 'action', 'nonce', false )` to verify nonce and allow JSON error handling.
- Ensure errors return appropriate HTTP status codes (403/400) via `wp_send_json_error( $data, $status )`.
- For taxonomy creation, verify the taxonomy exists (`taxonomy_exists`) before permission checks.

## Acceptance Criteria
- Unauthorized users receive JSON error responses.
- Authorized users can still open/save modal data.
- Taxonomy creation is limited to users with assign/edit term capabilities.

## Test Plan
- Add `WP_Ajax_UnitTestCase` tests for `foogallery_attachment_modal_open`, `foogallery_attachment_modal_save`, and `foogallery_attachment_modal_taxonomy_add`.
- Assert subscribers receive 403/JSON error even with valid nonce.
- Assert editors with `edit_post` can access and save.
- Include a test that invalid/empty `img_id` returns 400 error.
