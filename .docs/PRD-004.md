# PRD-004: Enforce Permissions on Datasource Modal AJAX

## Issue Summary
The datasource modal content AJAX endpoint verifies a nonce but does not enforce capability checks on the target gallery ID. This can allow unauthorized access to datasource info.

## Affected Endpoint
- `foogallery_load_datasource_content` in `includes/admin/class-gallery-datasources.php`

## Risk/Impact
- Unauthorized access to datasource configuration/metadata.
- Multisite cross-site information disclosure.

## Recommended Fix
1. After nonce verification, require:
   - `current_user_can( 'edit_post', $foogallery_id )`.
2. Validate inputs:
   - `absint` for `foogallery_id`.
   - Ensure `$datasource` is a known datasource key.
3. Use `wp_send_json_error` on failure rather than silent `die()`.

## Files/Functions
- `includes/admin/class-gallery-datasources.php`
  - `ajax_load_datasource_content()`

## Implementation Notes
- If the gallery does not exist, return 404.
- Consider limiting datasource keys to `foogallery_gallery_datasources()`.

## Acceptance Criteria
- Unauthorized users cannot access datasource modal content.
- Authorized users can load datasource content as before.

## Test Plan
- Add `WP_Ajax_UnitTestCase` coverage for `foogallery_load_datasource_content`.
- Assert a user without `edit_post` receives 403 even with valid nonce.
- Assert invalid datasource key returns 400.

## Final Cleanup
- After tests pass and the fix is complete, ask the user whether to delete this PRD and include the deletion in the final commit.
